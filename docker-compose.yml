version: '3'

################### NETWORKS

networks:
 raider-net:
   driver: bridge
   ipam:
     driver: default
     config:
       - subnet: 172.30.30.0/24

################### SERVICES

services:

  privoxy-vpn:
    # Needs a *.ovpn in /config/openvpn directory
    container_name: 'PrivoxyVPN'
    image: binhex/arch-privoxyvpn
    restart: unless-stopped
    networks:
      raider-net:
        ipv4_address: 172.30.30.30
    cap_add:
      - net_admin
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - .docker-files/privoxyvpn:/config
    environment:
      VPN_ENABLED: $ENABLE_PROXY
      VPN_PROV: pia
      VPN_CLIENT: openvpn
      ENABLE_SOCKS: $ENABLE_SOCKS_PROXY
      ENABLE_PRIVOXY: $ENABLE_PROXY
      LAN_NETWORK: 172.30.30.0/24
      NAME_SERVERS: 1.1.1.1,1.0.0.1
      STRICT_PORT_FORWARD: 'no'

  openvpn-client:
    # Needs a vpn.conf in ./vpn directory
    container_name: 'OpenVPNClient'
    image: dperson/openvpn-client
    restart: unless-stopped
    networks:
      - raider-net
    dns:
      - '1.1.1.1'
      - '1.0.0.1'
      - '8.8.8.8'
      - '8.8.4.4'
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - .docker-files/openvpn-client:/vpn

  raider:
    # Run the build command in makefile to build the image
    container_name: 'Raider'
    image: raider:latest
    restart: unless-stopped
    depends_on:
      - openvpn-client
    network_mode: 'service:openvpn-client'
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./settings.ini:/Raider/settings.ini
